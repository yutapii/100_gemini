#!/bin/bash
# inspect_pro.sh
# ç²¾å¯†æ¤œæŸ»ï¼ˆPro ğŸ’µğŸ’µğŸ’µğŸ’µğŸ’µğŸ’µã€æ·±å¤œå¸¯é™å®šï¼‰

set -euo pipefail

# å®šæ•°
readonly SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
readonly REPORTS_DIR="$SCRIPT_DIR/reports"
readonly EVIDENCE_DIR="${1:-}"
readonly TARGET_DIR="${2:-}"

# åˆæœŸåŒ–
mkdir -p "$REPORTS_DIR"

# å¼•æ•°ãƒã‚§ãƒƒã‚¯
if [[ -z "$EVIDENCE_DIR" ]] || [[ -z "$TARGET_DIR" ]]; then
    echo "ä½¿ã„æ–¹: $0 <è¨¼è·¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª> <å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª>"
    exit 1
fi

# æ·±å¤œå¸¯åˆ¤å®š
is_night_mode() {
    local hour=$(date +%H)
    if [ "$hour" -ge 1 ] && [ "$hour" -lt 6 ]; then
        return 0
    else
        return 1
    fi
}

# ç²¾å¯†æ¤œæŸ»å®Ÿè¡Œ
run_pro_inspection() {
    local evidence_dir="$1"
    local target_dir="$2"
    local ts="$(date '+%Y%m%d_%H%M%S')"
    local report="$REPORTS_DIR/${ts}_pro.md"

    # æ·±å¤œå¸¯ãƒã‚§ãƒƒã‚¯
    if ! is_night_mode; then
        echo "âš ï¸ æ·±å¤œå¸¯ã®ã¿å®Ÿè¡Œå¯èƒ½ï¼ˆ01:00-05:59ï¼‰"
        echo "ç¾åœ¨æ™‚åˆ»: $(date '+%H:%M')"
        return 1
    fi

    echo ""
    echo "ğŸ” ç²¾å¯†æ¤œæŸ»é–‹å§‹ï¼ˆPro ğŸ’µğŸ’µğŸ’µğŸ’µğŸ’µğŸ’µï¼‰"
    echo ""

    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆLevel 2 + ç²¾å¯†4é …ç›®ï¼‰
    local prompt="
ã‚ãªãŸã¯å“è³ªæ¤œæŸ»AIã§ã™ã€‚
è¨¼è·¡ãƒ­ã‚°ã‚’å¾¹åº•åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦åŸå‰‡ã€‘
1. æ¨æ¸¬ç¦æ­¢ï¼šè¨¼è·¡ãƒ­ã‚°ã®äº‹å®Ÿã®ã¿ã‚’æ ¹æ‹ ã¨ã™ã‚‹
2. ã‚³ãƒãƒ³ãƒ‰æœªå®Ÿè¡Œæ™‚ï¼šã€Œè¨¼è·¡ãªã—ã€ã¨æ˜è¨˜
3. åˆæ ¼/ä¸åˆæ ¼ã‚’æ˜ç¢ºã«åˆ¤å®š
4. â˜…wc.logã®ã€Œtotalã€è¡Œã¯åˆè¨ˆå€¤ã€ãƒ•ã‚¡ã‚¤ãƒ«è¡Œæ•°ã§ã¯ãªã„

ã€æ¤œæŸ»é …ç›®ã€‘
1. 500è¡Œ/ãƒ•ã‚¡ã‚¤ãƒ«åˆ¶ç´„ï¼ˆå¿…é ˆï¼‰
2. 80æ–‡å­—/è¡Œåˆ¶ç´„ï¼ˆå¿…é ˆï¼‰
3. æ©Ÿå¯†æƒ…å ±æ¼æ´©ï¼ˆå¿…é ˆï¼‰
4. æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ï¼ˆå¿…é ˆï¼‰
5. é–¢æ•°åˆ†å‰²ï¼ˆå˜ä¸€è²¬ä»»ï¼‰
6. å¤‰æ•°å‘½åè¦å‰‡
7. ã‚³ãƒ¡ãƒ³ãƒˆå“è³ª
8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
9. å†—é•·ã‚³ãƒ¼ãƒ‰æ¤œå‡º
10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§
11. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ
12. ä¿å®ˆæ€§è©•ä¾¡
13. TPSåŸå‰‡é©åˆæ€§

ã€å‡ºåŠ›å½¢å¼ã€‘
## Level 3æ¤œæŸ»çµæœï¼ˆç²¾å¯†ï¼‰

| é …ç›® | åˆ¤å®š | è¨¼è·¡ |
|------|------|------|
| å…¨13é …ç›® | âœ…/âŒ | è©³ç´° |

**ç·åˆåˆ¤å®š**: âœ…åˆæ ¼ / âŒä¸åˆæ ¼
"

    # Geminiå®Ÿè¡Œ
    if cd "$target_dir" && \
        gemini --model "gemini-2.5-pro" \
        "$prompt" > "$report" 2>&1; then
        cat "$report"
        echo ""
        echo "âœ… Level 3æ¤œæŸ»å®Œäº†"
        echo "ãƒ¬ãƒãƒ¼ãƒˆ: $report"
        return 0
    else
        echo "âŒ Level 3æ¤œæŸ»å¤±æ•—"
        cat "$report"
        return 1
    fi
}

# å®Ÿè¡Œ
run_pro_inspection "$EVIDENCE_DIR" "$TARGET_DIR"
